<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EasyClinic ‚Äî Relat√≥rios</title>
<script>
  const usuarioLogado = localStorage.getItem("usuario_logado");
  if (!usuarioLogado) {
    window.location.href = "login.html";
  }
</script>

<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --muted:#69707a;
  --accent:#4f46e5; --accent-2:#06b6d4;
  --shadow:0 6px 18px rgba(16,24,40,0.08);
  --radius:12px; --max-width:1200px;
  font-family:Inter,system-ui;
}
*{box-sizing:border-box}
body,html{margin:0;height:100%;background:var(--bg)}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
  width:260px;background:white;border-right:1px solid #e6eef6;
  padding:20px;display:flex;flex-direction:column;gap:14px;
  transition:.25s ease;
}
.sidebar.collapsed{width:72px;padding-left:10px;padding-right:10px}
.logo{
  width:44px;height:44px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:white;
}
.brand{display:flex;gap:12px;align-items:center;font-weight:700}
.titles{display:flex;flex-direction:column}
.small{font-size:12px;color:var(--muted)}
.sidebar.collapsed .titles,
.sidebar.collapsed .text,
.sidebar.collapsed .sidebar-footer{display:none}

.nav{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.nav a{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;
  font-weight:600;text-decoration:none;color:#0f172a;
}
.nav a:hover{background:#f1f5f9}
.nav .active{
  background:linear-gradient(90deg,rgba(79,70,229,0.12),rgba(6,182,212,0.06));
  box-shadow:var(--shadow);
}

.sidebar-footer{
  margin-top:auto;font-size:12px;color:var(--muted);text-align:center
}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column}

/* HEADER */
header{
  height:72px;display:flex;align-items:center;justify-content:space-between;
  padding:16px 28px;border-bottom:1px solid rgba(0,0,0,.05);
  position:relative;
}
.icon-btn{
  width:40px;height:40px;border-radius:10px;background:white;
  border:1px solid #e6eef6;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;
}
.icon-btn:hover{background:#eef2ff}
.search input{
  padding:10px 12px;border-radius:10px;border:1px solid #e6eef6;
  background:white;min-width:260px;
}

.avatar{
  width:40px;height:40px;border-radius:999px;background:#c7d2fe;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:#1e293b;cursor:pointer;
}

/* NOTIF POPUP */
.notif-popup{
  position:absolute;top:74px;right:28px;width:300px;background:white;
  border-radius:12px;box-shadow:var(--shadow);padding:12px;display:none;z-index:50;
}
.notif-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px;border:1px solid #eef3fb;background:white;
  margin-bottom:8px;border-radius:10px;
}
.meta{font-size:12px;color:var(--muted)}

/* CONTENT */
.content{padding:28px;max-width:var(--max-width);margin:0 auto;width:100%}
.box{
  background:white;padding:18px;border-radius:12px;
  box-shadow:var(--shadow);margin-bottom:22px;
}
.muted{color:var(--muted)}
.btn{
  padding:8px 12px;border-radius:10px;border:0;background:var(--accent);
  color:white;font-weight:700;cursor:pointer
}
.btn-ghost{
  padding:8px 12px;border-radius:10px;background:transparent;
  border:1px solid #e6eef6;color:#1e293b;font-weight:700;cursor:pointer
}
.hidden{display:none}

/* TABS */
.view-tabs{display:flex;gap:8px;margin-top:12px}
.tab{
  padding:8px 10px;border-radius:8px;border:1px solid #eef3fb;
  cursor:pointer;font-weight:600;transition:0.25s
}
.tab.active{
  background:linear-gradient(90deg,#eef2ff,#ecfeff);
  border-color:transparent
}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #eef3fb;text-align:left}

/* CHART */
canvas{width:100%!important;height:340px!important}
</style>
</head>

<body>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="brand">
    <div class="logo">EC</div>
    <div class="titles">
      <div>EasyClinic</div>
      <div class="small">Painel Administrativo</div>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html"><span class="icon">üè†</span><span class="text">In√≠cio</span></a>
    <a href="pacientes.html"><span class="icon">üò∑</span><span class="text">Pacientes</span></a>
    <a href="consultas.html"><span class="icon">üìã</span><span class="text">Consultas</span></a>
    <a href="agenda-medica.html"><span class="icon">üìÖ</span><span class="text">Agenda M√©dica</span></a>
    <a href="gerenciar-usuarios.html"><span class="icon">üë§</span><span class="text">Usu√°rios</span></a>
    <a class="active" href="relatorios.html"><span class="icon">üìä</span><span class="text">Relat√≥rios</span></a>
    <a href="configuracoes.html"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></a>
  </nav>

  <div class="sidebar-footer">Vers√£o 1.0</div>
</aside>

<!-- MAIN -->
<div class="main">

<header>

  <div style="display:flex;align-items:center;gap:12px;">
    <div id="btnToggle" class="icon-btn">‚ò∞</div>

    <!-- BUSCA DO HEADER (somente lista e tabela) -->
    <div class="search"><input id="searchHeader" placeholder="Buscar registros..."></div>
  </div>

  <div style="display:flex;align-items:center;gap:16px;position:relative;">

    <div id="btnNotif" class="icon-btn">üîî</div>

    <div id="notifPopup" class="notif-popup">
      <h4>Notifica√ß√µes</h4>
      <div class="notif-item"><div><strong>Relat√≥rio atualizado</strong><div class="meta">agora</div></div><div class="meta">Sistema</div></div>
      <div class="notif-item"><div><strong>Nova consulta</strong><div class="meta">10:00h</div></div><div class="meta">Recep√ß√£o</div></div>
      <div style="text-align:center;margin-top:8px"><button id="btnClearNotif" class="btn-ghost">Marcar todas como lidas</button></div>
    </div>

    <div style="text-align:right">
      <div style="font-size:13px;color:var(--muted)">Ol√°,</div>
      <div style="font-weight:700">Maria Silva</div>
    </div>

    <div id="avatar" class="avatar">MS</div>
  </div>
</header>

<main class="content">

  <h2>Relat√≥rios</h2>

  <!-- FILTROS -->
  <div class="box">
    <h3>Filtros de Pesquisa</h3>

    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <label class="muted">Per√≠odo (in√≠cio)</label><br>
        <input id="dataInicio" type="date">
      </div>

      <div>
        <label class="muted">Per√≠odo (fim)</label><br>
        <input id="dataFim" type="date">
      </div>

      <div>
        <label class="muted">Especialidade</label><br>
        <select id="fEspecialidade">
          <option value="">Todas</option>
        </select>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnBuscar" class="btn">üîç Buscar</button>
        <button id="btnLimpar" class="btn-ghost">Limpar</button>
      </div>
    </div>

    <div class="view-tabs">
      <div class="tab active" data-view="grafico" id="tabGraf">Gr√°fico</div>
      <div class="tab" data-view="lista" id="tabLista">Lista</div>
      <div class="tab" data-view="tabela" id="tabTabela">Tabela</div>
    </div>

    <div style="margin-top:8px;font-size:13px;color:var(--muted)">
      Visualiza√ß√µes s√≥ aparecem depois da pesquisa.
    </div>
  </div>

  <!-- GRAFICO GERAL -->
  <div id="boxGrafico" class="box hidden">
    <h3>Consultas por Dia</h3>
    <canvas id="graficoGeral"></canvas>
  </div>

  <!-- GRAFICO ESPECIALIDADES -->
  <div id="boxEspecialidades" class="box hidden">
    <h3>Consultas por Especialidade</h3>
    <canvas id="graficoEspecialidades"></canvas>
  </div>

  <!-- LISTA -->
  <div id="boxLista" class="box hidden">
    <h3>Lista Simplificada</h3>
    <ul id="listaRegistros"></ul>
  </div>

  <!-- TABELA -->
  <div id="boxTabela" class="box hidden">
    <h3>Tabela Completa</h3>

    <table>
      <thead>
        <tr>
          <th>Data</th><th>Paciente</th><th>M√©dico</th><th>Especialidade</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelaRegistros"></tbody>
    </table>
  </div>
</main>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* SIDEBAR */
btnToggle.onclick = ()=>sidebar.classList.toggle("collapsed");

/* NOTIF */
btnNotif.onclick = e=>{
  e.stopPropagation();
  notifPopup.style.display = notifPopup.style.display==="block" ? "none" : "block";
};
btnClearNotif.addEventListener('click', ()=>{
  // remove todos os itens existentes
  document.querySelectorAll('.notif-item').forEach(n => n.remove());

  // verifica se j√° existe a mensagem "Nenhuma notifica√ß√£o"
  const existe = notifPopup.querySelector('.empty-notif');
  if(!existe){
    const empty = document.createElement('div');
    empty.classList.add('empty-notif'); // adiciona classe para controle
    empty.style.textAlign = 'center';
    empty.style.color = 'var(--muted)';
    empty.style.padding = '8px';
    empty.textContent = 'Nenhuma notifica√ß√£o.';
    notifPopup.insertBefore(empty, btnClearNotif.parentElement);
  }
});

document.addEventListener("click", e=>{
  if(!notifPopup.contains(e.target) && e.target!==btnNotif)
    notifPopup.style.display="none";
});
avatar.onclick = ()=>location.href="configuracoes.html";

/* DADOS */
const especialidades = ["Cardiologia","Dermatologia","Ortopedia","Pediatria","Cl√≠nico Geral"];
const nomes = ["Jo√£o","Maria","Carlos","Ana","Pedro","Luiza","Paula","Ricardo","Mariana","Lucas","Sofia","Bruno"];
const medicos = ["Dr. Paulo","Dra. Ana","Dr. Ricardo","Dra. Luiza","Dr. Marcos"];

function gerarDados(){
  const registros = [];
  for(let i=0;i<60;i++){
    const d = new Date();
    d.setDate(d.getDate() - i);

    const status = Math.random() > 0.15 ? "Conclu√≠da" : "Cancelada";
    registros.push({
      dataObj:new Date(d.getFullYear(),d.getMonth(),d.getDate()),
      data:d.toLocaleDateString("pt-BR"),
      paciente: nomes[Math.floor(Math.random()*nomes.length)] + " " + 
                (Math.random()>0.5?"Silva":"Souza"),
      medico: medicos[Math.floor(Math.random()*medicos.length)],
      esp: especialidades[Math.floor(Math.random()*especialidades.length)],
      status
    });
  }
  return registros;
}

const registros = gerarDados();

/* POPULAR SELECT */
especialidades.forEach(e=>{
  const op=document.createElement("option");
  op.value=e;
  op.textContent=e;
  fEspecialidade.appendChild(op);
});

/* ELEMENTOS */
const boxGraf=document.getElementById("boxGrafico");
const boxEsp=document.getElementById("boxEspecialidades");
const boxLista=document.getElementById("boxLista");
const boxTabela=document.getElementById("boxTabela");
const tabGraf=document.getElementById("tabGraf");
const tabLista=document.getElementById("tabLista");
const tabTabelaBtn=document.getElementById("tabTabela");
const tabs=[tabGraf,tabLista,tabTabelaBtn];

function esconderTudo(){
  boxGraf.classList.add("hidden");
  boxEsp.classList.add("hidden");
  boxLista.classList.add("hidden");
  boxTabela.classList.add("hidden");
}
function marcarTabAtiva(v){
  tabs.forEach(t=>t.classList.toggle("active",t.dataset.view===v));
}

tabGraf.onclick=()=>{marcarTabAtiva("grafico");mostrarView("grafico")};
tabLista.onclick=()=>{marcarTabAtiva("lista");mostrarView("lista")};
tabTabelaBtn.onclick=()=>{marcarTabAtiva("tabela");mostrarView("tabela")};

function mostrarView(v){
  esconderTudo();
  if(v==="grafico"){ boxGraf.classList.remove("hidden"); boxEsp.classList.remove("hidden"); }
  if(v==="lista"){ boxLista.classList.remove("hidden"); }
  if(v==="tabela"){ boxTabela.classList.remove("hidden"); }
}

/* PARSE DATE */
function parseDateInput(v){
  if(!v) return null;
  const p=v.split("-");
  return new Date(p[0],p[1]-1,p[2]);
}

/* BUSCA */
function buscar(){
  const di=parseDateInput(dataInicio.value);
  const df=parseDateInput(dataFim.value);
  const esp=fEspecialidade.value;

  const inicio=di || registros[registros.length-1].dataObj;
  const fim=df || registros[0].dataObj;

  const filtrados = registros.filter(r =>
    r.dataObj>=inicio &&
    r.dataObj<=fim &&
    (esp ? r.esp===esp : true)
  ).sort((a,b)=>b.dataObj - a.dataObj);

  /* TABELA */
  tabelaRegistros.innerHTML="";
  filtrados.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>${r.paciente}</td>
      <td>${r.medico}</td>
      <td>${r.esp}</td>
      <td>${r.status}</td>
    `;
    tabelaRegistros.appendChild(tr);
  });

  /* LISTA */
  listaRegistros.innerHTML="";
  filtrados.slice(0,200).forEach(r=>{
    const li=document.createElement("li");
    li.textContent=`${r.data} ‚Äî ${r.paciente} ‚Äî ${r.medico} ‚Äî ${r.esp} ‚Äî ${r.status}`;
    listaRegistros.appendChild(li);
  });

  /* CHARTS */
  const mapDia={};
  filtrados.forEach(r=>{
    mapDia[r.data]=(mapDia[r.data]||0)+1;
  });

  const labels = Object.keys(mapDia).sort((a,b)=>{
    const da=new Date(a.split("/").reverse().join("-"));
    const db=new Date(b.split("/").reverse().join("-"));
    return da - db;
  });
  const values = labels.map(k=>mapDia[k]);

  const mapEsp={};
  especialidades.forEach(e=>mapEsp[e]=0);
  filtrados.forEach(r=>mapEsp[r.esp]++);

  const v=document.querySelector(".tab.active").dataset.view;
  mostrarView(v);

  if(window._chartG) window._chartG.destroy();
  if(window._chartE) window._chartE.destroy();

  window._chartG = new Chart(document.getElementById("graficoGeral"),{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"Consultas",
        data:values,
        borderColor:"#4f46e5",
        backgroundColor:"rgba(79,70,229,0.15)",
        fill:true,tension:0.3,pointRadius:3
      }]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  window._chartE = new Chart(document.getElementById("graficoEspecialidades"),{
    type:"bar",
    data:{
      labels:especialidades,
      datasets:[{
        label:"Quantidade",
        data:especialidades.map(e=>mapEsp[e]),
        backgroundColor:["#4f46e5","#06b6d4","#5b21b6","#059669","#dc2626"]
      }]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  if(filtrados.length===0){
    tabelaRegistros.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--muted)">Nenhum registro encontrado.</td></tr>';
    listaRegistros.innerHTML='<li style="color:var(--muted)">Nenhum registro encontrado.</li>';
  }
}

/* BUSCA DO HEADER ‚Äî somente lista e tabela */
searchHeader.oninput = ()=>{
  const termo = searchHeader.value.toLowerCase();

  document.querySelectorAll("#boxTabela tbody tr").forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(termo) ? "" : "none";
  });

  document.querySelectorAll("#boxLista li").forEach(li=>{
    li.style.display = li.textContent.toLowerCase().includes(termo) ? "" : "none";
  });
};

/* BOT√ïES */
btnBuscar.onclick = e=>{e.preventDefault();buscar()};
btnLimpar.onclick = ()=>{
  dataInicio.value="";
  dataFim.value="";
  fEspecialidade.value="";
  esconderTudo();
  marcarTabAtiva("grafico");
};

/* INICIAL */
marcarTabAtiva("grafico");
esconderTudo();

/* DATAS INICIAIS */
(function(){
  const hoje=new Date();
  const ini=new Date();
  ini.setDate(hoje.getDate()-29);

  const pad=n=>n.toString().padStart(2,"0");
  const fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  dataInicio.value=fmt(ini);
  dataFim.value=fmt(hoje);
})();

const user = JSON.parse(localStorage.getItem("usuario_logado"));

if (user) {
  // Nome do usu√°rio no header
  document.querySelector("header div div[style*='font-weight']").textContent =
    user.nome;

  // Avatar com iniciais
  const iniciais = user.nome
    .split(" ")
    .map(p => p[0])
    .join("")
    .toUpperCase();

  document.getElementById("avatar").textContent = iniciais;
}
</script>
</body>
</html>