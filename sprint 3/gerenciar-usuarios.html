<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EasyClinic ‚Äî Usu√°rios</title>

<!-- Valida√ß√£o r√°pida de sess√£o: se n√£o logado -> login.html -->
<script>
  const usuarioLogado = localStorage.getItem("usuario_logado");
  if (!usuarioLogado) {
    window.location.href = "login.html";
  }
</script>

<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --muted:#69707a;
  --accent:#4f46e5; --accent-2:#06b6d4;
  --shadow:0 6px 18px rgba(16,24,40,0.08);
  --radius:12px; --max-width:1200px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box}
body,html{margin:0;background:var(--bg);height:100%}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
  width:260px;background:white;border-right:1px solid #e6eef6;
  padding:20px;display:flex;flex-direction:column;gap:14px;
  transition:.25s ease;
}
.sidebar.collapsed{width:72px;padding-left:10px;padding-right:10px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:white;font-weight:700;display:flex;align-items:center;justify-content:center}
.brand{display:flex;gap:12px;align-items:center;font-weight:700}
.titles{display:flex;flex-direction:column}
.small{font-size:12px;color:var(--muted)}
.nav{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.nav a{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;
  font-weight:600;text-decoration:none;color:#0f172a;
}
.nav a:hover{background:#f1f5f9}
.nav .active{
  background:linear-gradient(90deg,rgba(79,70,229,0.12),rgba(6,182,212,0.06));
  box-shadow:var(--shadow);
}
.sidebar.collapsed .titles,
.sidebar.collapsed .text,
.sidebar.collapsed .sidebar-footer{display:none}
.sidebar-footer{margin-top:auto;font-size:12px;color:var(--muted);text-align:center}

/* HEADER */
.main{flex:1;display:flex;flex-direction:column}
header{
  height:72px;display:flex;align-items:center;justify-content:space-between;
  padding:16px 28px;border-bottom:1px solid rgba(0,0,0,.05);position:relative;
}
.icon-btn{
  width:40px;height:40px;border-radius:10px;background:white;
  border:1px solid #e6eef6;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;
}
.icon-btn:hover{background:#eef2ff}

.avatar{
  width:40px;height:40px;border-radius:999px;background:#c7d2fe;
  display:flex;align-items:center;justify-content:center;font-weight:700;color:#1e293b;cursor:pointer;
}

/* NOTIF POPUP */
.notif-popup{
  position:absolute;top:74px;right:28px;width:300px;background:white;
  border-radius:12px;box-shadow:var(--shadow);padding:12px;display:none;z-index:50;
}
.notif-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px;border:1px solid #eef3fb;background:#ffffff;margin-bottom:8px;border-radius:10px;
}
.meta{font-size:12px;color:var(--muted)}

/* CONTENT */
.content{padding:28px;max-width:var(--max-width);margin:0 auto}

/* TABLE / FORM */
.box{
  background:white;padding:18px;border-radius:12px;box-shadow:var(--shadow);
}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
th,td{padding:12px;border-bottom:1px solid #eef3fb;text-align:left}

.btn-add{
  padding:10px 14px;border-radius:10px;border:0;background:var(--accent);
  color:white;font-weight:700;cursor:pointer
}

/* SEARCH INPUT INTERNO */
.filter-input{
  padding:10px 12px;border-radius:10px;border:1px solid #e6eef6;
  background:white;width:100%;
}

/* PANEL */
.panel{
  width:420px;height:100vh;background:white;position:fixed;top:0;right:-420px;
  box-shadow:-4px 0 14px rgba(0,0,0,.08);
  transition:.3s;padding:24px;overflow-y:auto;z-index:90;
}
.panel.open{right:0}
.panel label{font-size:13px;color:var(--muted)}
.panel input, .panel select{
  width:100%;padding:10px;border:1px solid #dce3ed;border-radius:10px;margin-bottom:12px;
}
.save-btn{
  width:100%;padding:10px;background:var(--accent);border:0;border-radius:10px;
  color:white;font-weight:700;margin-top:10px;cursor:pointer
}
.cancel-btn{
  width:100%;padding:10px;background:white;border:1px solid #dce3ed;
  border-radius:10px;color:#1e293b;font-weight:600;margin-top:6px;cursor:pointer
}

/* small responsive */
@media (max-width:900px){
  .filter-input{width:100%}
}

/* Bot√µes de a√ß√µes da tabela */
.actions-cell button {
  padding: 6px 10px;
  border-radius: 8px;
  background: transparent;
  border: 1px solid #e2e8f0;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: .2s;
}

.actions-cell button:hover {
  background: #f1f5f9;
}

/* Bot√£o ativar/desativar */
.btn-toggle {
  color: var(--accent);
  border-color: var(--accent);
}
.btn-toggle:hover {
  background: rgba(79, 70, 229, 0.12);
}

/* Bot√£o excluir */
.btn-delete {
  color: #ef4444;
  border-color: #ef4444;
}
.btn-delete:hover {
  background: rgba(239, 68, 68, 0.12);
}
</style>
</head>

<body>

<div class="app">

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
  <div class="brand">
    <div class="logo">EC</div>
    <div class="titles"><div>EasyClinic</div><div class="small">Painel Administrativo</div></div>
  </div>

  <nav class="nav">
    <a href="index.html"><span class="icon">üè†</span><span class="text">In√≠cio</span></a>
    <a href="pacientes.html"><span class="icon">üò∑</span><span class="text">Pacientes</span></a>
    <a href="consultas.html"><span class="icon">üìã</span><span class="text">Consultas</span></a>
    <a href="agenda-medica.html"><span class="icon">üìÖ</span><span class="text">Agenda M√©dica</span></a>
    <a class="active" href="gerenciar-usuarios.html"><span class="icon">üë§</span><span class="text">Usu√°rios</span></a>
    <a href="relatorios.html"><span class="icon">üìä</span><span class="text">Relat√≥rios</span></a>
    <a href="configuracoes.html"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></a>
  </nav>

  <div class="sidebar-footer">Vers√£o 1.0</div>
</aside>

<!-- MAIN -->
<div class="main">

<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <div id="btnToggle" class="icon-btn">‚ò∞</div>
  </div>

  <div style="display:flex;align-items:center;gap:16px;position:relative;">
    <div id="btnNotif" class="icon-btn">üîî</div>

    <div id="notifPopup" class="notif-popup" aria-hidden="true">
      <h4>Notifica√ß√µes</h4>
      <div class="notif-item"><div><strong>Usu√°rio cadastrado</strong><div class="meta">30 min atr√°s</div></div><div class="meta">Admin</div></div>
      <div style="text-align:center;margin-top:8px"><button id="btnClearNotif" class="btn-ghost">Marcar todas como lidas</button></div>
    </div>

    <div style="text-align:right">
      <div style="font-size:13px;color:var(--muted)">Ol√°,</div>
      <div id="headerUserName" style="font-weight:700">Carregando...</div>
    </div>

    <div id="avatar" class="avatar" title="Meu perfil">?</div>
  </div>
</header>

<main class="content">
  <h2>Usu√°rios</h2>

  <button id="btnNovo" class="btn-add">+ Novo Usu√°rio</button>

  <div class="box" style="margin-top:18px;">
    <div style="display:flex;gap:12px;margin-bottom:12px">
      <input id="filtroBusca" class="filter-input" type="text" placeholder="Buscar por nome...">
      <select id="filtroTipo" class="filter-input">
        <option value="">Todos os tipos</option>
        <option>Administrador</option>
        <option>Recepcionista</option>
        <option>M√©dico</option>
      </select>
      <select id="filtroStatus" class="filter-input">
        <option value="">Todos os status</option>
        <option>Ativo</option>
        <option>Inativo</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th><th>Email</th><th>CPF</th><th>Tipo</th><th>Status</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaUsuarios"></tbody>
    </table>
  </div>
</main>
</div>
</div>

<!-- PANEL CADASTRO -->
<div id="panel" class="panel" aria-hidden="true">
  <h2 id="formTitulo">Novo Usu√°rio</h2>

  <label>Nome</label>
  <input id="nomeUsuario" type="text">

  <label>E-mail</label>
  <input id="emailUsuario" type="email">

  <label>CPF</label>
  <input id="cpfUsuario" type="text" maxlength="14" placeholder="000.000.000-00">

  <label>Senha</label>
  <input id="senhaUsuario" type="password" placeholder="M√≠nimo 3 caracteres">

  <label>Tipo</label>
  <select id="tipoUsuario">
    <option>Administrador</option>
    <option>Recepcionista</option>
    <option>M√©dico</option>
  </select>

  <button id="btnSalvar" class="save-btn">Salvar</button>
  <button id="btnCancelar" class="cancel-btn">Cancelar</button>
</div>

<script>
/* ---------- Inicializa DB de usu√°rios caso n√£o exista ---------- */
(function initDB(){
  const db = localStorage.getItem('db_usuarios');
  if(!db){
    // Usu√°rios demo (mesmos nomes que voc√™ forneceu)
    const initial = [
      {nome:"Maria Silva", email:"maria@easy.com", cpf:"123.456.789-00", senha:"123", tipo:"Administrador", status:"Ativo"},
      {nome:"Jo√£o Pedro", email:"joao@easy.com", cpf:"987.654.321-10", senha:"123", tipo:"Recepcionista", status:"Ativo"},
      {nome:"Dra. Ana", email:"ana@easy.com", cpf:"111.222.333-44", senha:"123", tipo:"M√©dico", status:"Inativo"},
      // opcional: usu√°rio demo admin
      {nome:"Admin Demo", email:"admin@admin.com", cpf:"000.000.000-00", senha:"123", tipo:"Administrador", status:"Ativo"}
    ];
    localStorage.setItem('db_usuarios', JSON.stringify(initial));
    console.log("db_usuarios inicializado.");
  }
})();

/* ---------- Helpers DB ---------- */
function getUsuariosDB(){
  return JSON.parse(localStorage.getItem('db_usuarios') || "[]");
}
function saveUsuariosDB(lista){
  localStorage.setItem('db_usuarios', JSON.stringify(lista));
}

/* ---------- Element refs ---------- */
const sidebar = document.getElementById('sidebar');
const btnToggle = document.getElementById('btnToggle');
const btnNotif = document.getElementById('btnNotif');
const notifPopup = document.getElementById('notifPopup');
const avatar = document.getElementById('avatar');

const panel = document.getElementById('panel');
const btnNovo = document.getElementById('btnNovo');
const btnCancelar = document.getElementById('btnCancelar');
const btnSalvar = document.getElementById('btnSalvar');

const nomeUsuario = document.getElementById('nomeUsuario');
const emailUsuario = document.getElementById('emailUsuario');
const cpfUsuario = document.getElementById('cpfUsuario');
const senhaUsuario = document.getElementById('senhaUsuario');
const tipoUsuario = document.getElementById('tipoUsuario');

const filtroBusca = document.getElementById('filtroBusca');
const filtroTipo = document.getElementById('filtroTipo');
const filtroStatus = document.getElementById('filtroStatus');
const tabelaUsuarios = document.getElementById('tabelaUsuarios');

const headerUserName = document.getElementById('headerUserName');

/* ---------- Intera√ß√µes UI ---------- */
btnToggle.onclick = () => sidebar.classList.toggle('collapsed');

btnNotif.onclick = e=>{
  e.stopPropagation();
  notifPopup.style.display = notifPopup.style.display === "block" ? "none" : "block";
};
btnClearNotif.addEventListener('click', ()=>{
  // remove todos os itens existentes
  document.querySelectorAll('.notif-item').forEach(n => n.remove());

  // verifica se j√° existe a mensagem "Nenhuma notifica√ß√£o"
  const existe = notifPopup.querySelector('.empty-notif');
  if(!existe){
    const empty = document.createElement('div');
    empty.classList.add('empty-notif'); // adiciona classe para controle
    empty.style.textAlign = 'center';
    empty.style.color = 'var(--muted)';
    empty.style.padding = '8px';
    empty.textContent = 'Nenhuma notifica√ß√£o.';
    notifPopup.insertBefore(empty, btnClearNotif.parentElement);
  }
});

document.addEventListener('click', e=>{
  if(!notifPopup.contains(e.target) && e.target !== btnNotif){
    notifPopup.style.display = "none";
  }
});
avatar.onclick = ()=>location.href="configuracoes.html";

/* ---------- CPF mask ---------- */
cpfUsuario.addEventListener("input", e=>{
  let v = e.target.value.replace(/\D/g,"");
  v = v.replace(/(\d{3})(\d)/,"$1.$2");
  v = v.replace(/(\d{3})(\d)/,"$1.$2");
  v = v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");
  e.target.value = v;
});

/* ---------- CPF validation ---------- */
function validaCPF(cpf){
  cpf = cpf.replace(/\D/g,"");
  if(cpf.length !== 11) return false;
  if(/^(.)\1+$/.test(cpf)) return false;
  let soma=0, resto;
  for(let i=1;i<=9;i++) soma += parseInt(cpf[i-1]) * (11 - i);
  resto = (soma * 10) % 11;
  if(resto === 10 || resto === 11) resto = 0;
  if(resto !== parseInt(cpf[9])) return false;
  soma = 0;
  for(let i=1;i<=10;i++) soma += parseInt(cpf[i-1]) * (12 - i);
  resto = (soma * 10) % 11;
  if(resto === 10 || resto === 11) resto = 0;
  return resto === parseInt(cpf[10]);
}

/* ---------- Render robust (usa email como ID) ---------- */
function renderRobust(){
  const usuarios = getUsuariosDB();
  const filtroNome = (filtroBusca.value || "").toLowerCase();
  const filtroT = filtroTipo.value;
  const filtroS = filtroStatus.value;

  tabelaUsuarios.innerHTML = "";

  usuarios.forEach(u => {
    if(!u.nome.toLowerCase().includes(filtroNome)) return;
    if(filtroT && u.tipo !== filtroT) return;
    if(filtroS && u.status !== filtroS) return;

    tabelaUsuarios.innerHTML += `
      <tr>
        <td>${u.nome}</td>
        <td>${u.email}</td>
        <td>${u.cpf}</td>
        <td>${u.tipo}</td>
        <td><span style="color:${u.status==='Ativo'?'var(--accent)':'#ef4444'};font-weight:700">${u.status}</span></td>
        <td class="actions-cell">
          <button class="btn-ghost" style="margin-right:6px" onclick="toggleStatus('${u.email}')">${u.status==='Ativo'?'Desativar':'Ativar'}</button>
          <button class="btn-ghost" style="color:#ef4444" onclick="removeUser('${u.email}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

/* Expondo para onclick inline */
window.toggleStatus = (email) => {
  let db = getUsuariosDB();
  const idx = db.findIndex(x => x.email === email);
  if(idx !== -1){
    db[idx].status = db[idx].status === "Ativo" ? "Inativo" : "Ativo";
    saveUsuariosDB(db);
    renderRobust();
  }
};

window.removeUser = (email) => {
  if(!confirm("Tem certeza que deseja remover este usu√°rio?")) return;
  let db = getUsuariosDB();
  db = db.filter(u => u.email !== email);
  saveUsuariosDB(db);
  renderRobust();
};

/* ---------- Novo usu√°rio (painel) ---------- */
btnNovo.onclick = ()=>{
  document.getElementById('formTitulo').textContent = "Novo Usu√°rio";
  nomeUsuario.value = "";
  emailUsuario.value = "";
  cpfUsuario.value = "";
  senhaUsuario.value = "";
  tipoUsuario.value = "Administrador";
  panel.classList.add('open');
  panel.setAttribute('aria-hidden','false');
};
btnCancelar.onclick = ()=> {
  panel.classList.remove('open');
  panel.setAttribute('aria-hidden','true');
};

/* Salvar usu√°rio */
btnSalvar.onclick = ()=>{
  const nome = nomeUsuario.value.trim();
  const email = emailUsuario.value.trim().toLowerCase();
  const cpf = cpfUsuario.value.trim();
  const senha = senhaUsuario.value;
  const tipo = tipoUsuario.value;

  if(!nome || !email || !cpf || !senha){
    alert("Preencha todos os campos, incluindo a senha.");
    return;
  }
  if(!validaCPF(cpf)){
    alert("CPF inv√°lido.");
    return;
  }
  if(senha.length < 3){
    alert("Senha muito curta. M√≠nimo 3 caracteres.");
    return;
  }

  const db = getUsuariosDB();
  if(db.some(u => u.email === email)){
    alert("E-mail j√° cadastrado!");
    return;
  }

  db.push({nome, email, cpf, senha, tipo, status:"Ativo"});
  saveUsuariosDB(db);
  panel.classList.remove('open');
  panel.setAttribute('aria-hidden','true');
  renderRobust();
  alert("Usu√°rio cadastrado com sucesso!");
};

/* ---------- Busca / filtros ---------- */
filtroBusca.oninput = renderRobust;
filtroTipo.onchange = renderRobust;
filtroStatus.onchange = renderRobust;

/* ---------- Inicial render ---------- */
renderRobust();

/* ---------- Mostra nome e iniciais do usu√°rio logado no header/avatar ---------- */
(function setHeaderUser(){
  try{
    const user = JSON.parse(localStorage.getItem("usuario_logado"));
    if(user && user.nome){
      headerUserName.textContent = user.nome;
      const iniciais = user.nome.split(" ").map(p=>p[0]||"").join("").substring(0,2).toUpperCase();
      avatar.textContent = iniciais;
    } else {
      // fallback
      headerUserName.textContent = "Usu√°rio";
      avatar.textContent = "U";
    }
  }catch(e){
    headerUserName.textContent = "Usu√°rio";
    avatar.textContent = "U";
  }
})();
</script>
</body>
</html>